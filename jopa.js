const { Bot, InlineKeyboard } = require("grammy");


// –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞
const bot = new Bot("8242094324:AAHMatw9XhDaiC7TXXetPLB33EPpzXSCRQ0"); // <-- place your bot token in this string

const userStat = [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bot.command('start', async (ctx) => {
    saveUser(ctx.from.id)

    let userName = ctx.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    await ctx.reply("–ü—Ä–∏–≤–µ—Ç, "+userName+"! –Ø –±–æ—Ç ü§ñ, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã.", { reply_markup: menuKeyboard });
    console.log("–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: " + userName);
});

bot.command('history', (ctx) => {

})

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /help
bot.command('help', async (ctx) => {
    const helpMessage =
        `–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
        /start: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–æ—Ç–∞
        /history: –≤—ã–≤–æ–¥–∏—Ç –ø—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        /help: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
        ;`
    await ctx.reply(helpMessage);
    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å.');
});

function answerQuestion(question) {
    const answers = ["–î–∞, —ç—Ç–æ –≤–ø–æ–ª–Ω–µ –≤–µ—Ä–æ—è—Ç–Ω–æ", "–ë–µ–∑—É—Å–ª–æ–≤–Ω–æ, —Ç–∞–∫–æ–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏", "–®–∞–Ω—Å—ã –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏", "–í—Å—ë –∫ —ç—Ç–æ–º—É –∏–¥—ë—Ç", "–≠—Ç–æ –±–æ–ª–µ–µ —á–µ–º —Ä–µ–∞–ª—å–Ω–æ", "–î–∞, –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±–ª–∏–∑–∫–∞ –∫ —Å—Ç–æ–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π", "–í—Å–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å", "–®–∞–Ω—Å—ã –ø—è—Ç—å–¥–µ—Å—è—Ç –Ω–∞ –ø—è—Ç—å–¥–µ—Å—è—Ç", "–í–ø–æ–ª–Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ –Ω–µ —Ñ–∞–∫—Ç", "–ò—Å—Ö–æ–¥ –Ω–µ–æ—á–µ–≤–∏–¥–µ–Ω, –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –æ–Ω–∞ –Ω–µ–≤–µ–ª–∏–∫–∞", "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑", "–≠—Ç–æ –Ω–µ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –Ω–æ –∏ –∏—Å–∫–ª—é—á–∞—Ç—å –Ω–µ–ª—å–∑—è", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –µ—Å—Ç—å, –∫–∞–∫ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è", "–°–ª—É—á–∏—Ç—å—Å—è –º–æ–∂–µ—Ç, –∞ –º–æ–∂–µ—Ç –∏ –Ω–µ—Ç", "–ö—Ä–∞–π–Ω–µ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ", "–ù–µ—Ç, –ø—Ä–µ–¥–ø–æ—Å—ã–ª–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫ –Ω—É–ª—é", "–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç"]


    return answers[Math.floor(Math.random() * 20)]
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message:text', async (ctx) => {
    const userMessage = ctx.message.text.trim();

    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "/" - —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞
    if (userMessage.startsWith('/')) {
        // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
        await ctx.reply('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.');
        console.log("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + userMessage);
        return;
    }

    if (userMessage.length === 0) {
        await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å.');
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã.');
    } else {

        if (userMessage.endsWith("?")) {
            ctx.reply(answerQuestion())
        }else {
            ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å.')
        }
        
        await ctx.reply();
        console.log();
    }
})


const menuKeyboard = new InlineKeyboard()
    .text("–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", "ask_question")
    .text("–ò—Å—Ç–æ—Ä–∏—è", "history")

bot.callbackQuery('ask_question', (ctx) => {
    ctx.deleteMessage();
    ctx.answerCallbackQuery();
    ctx.reply("–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å: ");
})



bot.callbackQuery('statistic', (ctx) => {
    ctx.deleteMessage();
    ctx.answerCallbackQuery();

    let user = userStat.get(ctx.from.id)

    ctx.reply(`–ü–æ–±–µ–¥: ${user.wins}, –ü–æ—Ä–∞–∂–µ–Ω–∏–π: ${user.loses}`);
})


// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err) => {
    console.error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:', err);
})



function saveUser(user_id) {

if (userStat.get(user_id)) return;
    userStat.set(user_id, { wins: 0, loses: 0 })

    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ', userStat)
}

function updateUserHistory(user_id, question) {
    if(!userStat.get(user_id)) saveUser(user_id);

    let user = userStat.get(user_id)
    if (userStat.length() == 5) {
        let temp1 = userStat[1]
        let temp2 = userStat[2]
        let temp3 = userStat[3]
        let temp4 = userStat[4]

        userStat[0] = temp1
        userStat[1] = temp2
        userStat[2] = temp3
        userStat[3] = temp4

        userStat[4] = question
    }
    userStat.add(question)
}

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.start();
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...');